<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Путевой лист — Volovo</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
/* ================== ПЕРЕМЕННЫЕ ================== */
:root{
  --bg:#f5f7fa;
  --card:#ffffff;
  --line:#dce1e6;
  --text:#222;
  --muted:#555;
  --accent:#4a8dff;
  --danger:#ffb3b3;
  --shadow:0 4px 18px rgba(0,0,0,0.08);
  --shadow-soft:0 3px 12px rgba(0,0,0,0.06);
  --radius:14px;
}

/* ================== ОСНОВА ================== */
body{
  background:var(--bg);
  font-family:"Inter","Segoe UI",Arial,system-ui,sans-serif;
  color:var(--text);
  margin:20px;
}

/* общий контейнер */
.wrap{
  max-width:1200px;
  margin:0 auto;
  padding-bottom:40px;
}

/* ================== ТАБЛИЦА ================== */
table.sheet{
  width:100%;
  table-layout:auto;              /* автоширина колонок */
  border-collapse:separate;
  border-spacing:0;
  background:var(--card);
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:0 4px 22px rgba(0,0,0,0.08);
  font-size:13px;
}

.sheet th,
.sheet td{
  padding:8px 10px;
  vertical-align:middle;
  background:#fff;
  border:none;                    /* убрали жирные линии */
  word-wrap:break-word;
}

.sheet th{
  background:#f0f2f5;
  font-weight:600;
  color:#333;
}

.sheet tr:nth-child(even) td{
  background:#fafafa;
}

/* первая колонка — под ширину текста */
.sheet th:first-child,
.sheet td:first-child{
  white-space:nowrap;
  width:1%;
}

/* отключаем excel-жирные линии */
.thick-l,
.thick-r,
.thick-b{
  border:none !important;
}

/* поля внутри таблицы */
.sheet input,
.sheet select{
  width:100%;
  padding:6px 8px;
  background:#fff;
  border-radius:6px;
  border:1px solid #d0d4da;
  font:inherit;
  transition:0.15s;
}

.sheet input:focus,
.sheet select:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(74,141,255,0.25);
}

.bg-red{
  background:var(--danger)!important;
  font-weight:700;
}

/* заголовок */
.title{
  font-size:18px;
  padding:14px 0;
  text-align:center;
  background:linear-gradient(90deg,#f0f0f5,#fafafa);
  border-bottom:1px solid var(--line);
  letter-spacing:4px;
  font-weight:700;
}

.center{ text-align:center; }
.right{ text-align:right; }
.muted{ color:var(--muted); font-size:12px; }

/* ================== ФИЛЬТРЫ ================== */
.filters{
  margin-top:18px;
  background:var(--card);
  border-radius:var(--radius);
  padding:18px;
  display:flex;
  gap:16px;
  flex-wrap:wrap;
  align-items:flex-end;
  box-shadow:var(--shadow-soft);
}

.filters label{
  display:flex;
  flex-direction:column;
  gap:6px;
  font-size:13px;
  color:var(--muted);
}

.filters input,
.filters select{
  padding:8px 10px;
  border-radius:10px;
  border:1px solid #ccd1d8;
  background:#fff;
  font-size:14px;
}

.filters input:focus,
.filters select:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(74,141,255,0.25);
}

.filters button{
  background:var(--accent);
  border:none;
  padding:10px 18px;
  border-radius:10px;
  color:white;
  font-weight:600;
  cursor:pointer;
  transition:0.2s;
}

.filters button:hover{
  background:#3a79e0;
  transform:translateY(-1px);
}

.filters button:active{
  transform:scale(0.97);
}

.stat{
  margin-left:auto;
  background:#f9fafc;
  border:1px solid #d0d6dd;
  border-radius:10px;
  padding:10px 14px;
  font-size:14px;
  min-width:460px;
  box-shadow:inset 0 0 4px rgba(0,0,0,0.05);
}

/* ================== КАРТА ================== */
.mapBox{
  margin-top:18px;
  background:var(--card);
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:var(--shadow);
}

.mapHeader{
  background:#f5f7fa;
  border-bottom:1px solid var(--line);
  padding:12px 16px;
  font-size:15px;
  font-weight:600;
}

#map{
  width:100%;
  height:520px;
}

/* ================== ПЕЧАТЬ ================== */
@media print{
  body{ background:white; }
  table.sheet,
  .filters,
  .mapBox{ box-shadow:none; }
}
  </style>
</head>

<body>
<div class="wrap">

  <table class="sheet" id="sheet">
    <colgroup>
      <col class="c26"><col class="c27"><col class="c28"><col class="c29"><col class="c30">
      <col class="c31"><col class="c32"><col class="c33"><col class="c34"><col class="c35">
      <col class="c36"><col class="c37"><col class="c38"><col class="c39"><col class="c40">
    </colgroup>

    <tr>
      <th colspan="13" class="title thick-b">ПОСЛЕДОВАТЕЛЬНОСТЬ ВЫПОЛНЕНИЯ ЗАДАНИЯ</th>
      <th rowspan="3" class="center thick-l thick-b">подпись</th>
      <th rowspan="3" class="center thick-b">расшифровка</th>
    </tr>

    <tr>
      <th rowspan="2" class="center thick-r">пункт погрузки, разгрузки<br>и перецепки прицепов</th>
      <th rowspan="2" class="center thick-r">номер<br>ездки</th>

      <th colspan="3" class="center thick-r">прибытие</th>

      <th colspan="3" class="center thick-r">параметры дороги (из справочника)</th>

      <th class="center thick-r">номер прицепа</th>
      <th class="center thick-r">порожний<br>пробег<br>прицепа</th>
      <th colspan="3" class="center thick-r">номера приложенных ТТД</th>
    </tr>

    <tr>
      <th class="center"></th>
      <th class="center bg-yellow">км</th>
      <th class="center bg-green thick-r">тонн</th>

      <th class="center">ширина (м)</th>
      <th class="center">длина (км)</th>
      <th class="center thick-r">тоннаж (т)</th>

      <th class="center thick-r"></th>
      <th class="center thick-r"></th>

      <th class="center">Доставка</th>
      <th class="center">37</th>
      <th class="center thick-r">Холостой ход</th>
    </tr>

    <!-- 8 строк -->
    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">1</td>
      <td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r">
        <input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder="">
      </td>
      <td class="center js-width"></td>
      <td class="right js-length"></td>
      <td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td>
      <td class="right thick-r"></td>
      <td class="right delivery-cell"></td>
      <td></td>
      <td class="right thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">2</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">3</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">4</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">5</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">6</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">7</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">8</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <!-- ИТОГО -->
    <tr>
      <td class="thick-r"></td>
      <td class="thick-r"></td>
      <td></td>
      <td class="right bg-yellow" id="total_km_sum_cell">0,00</td>
      <td class="right bg-green thick-r" id="total_tons_sum_cell">0,00</td>
      <td></td>
      <td class="center bg-red" id="total_km_points_cell">0,00</td>
      <td class="center thick-r" id="vehicle_tonnage_cell">—</td>
      <td class="center thick-r" id="trips_count_cell">—</td>
      <td class="center thick-r" id="total_tons_cell">—</td>

      <td class="right" id="ttd_km_delivery_cell"></td>
      <td></td>
      <td class="right thick-r" id="ttd_38_idle_cell"></td>

      <td class="thick-l"></td><td></td>
    </tr>
  </table>

  <div class="filters">
    <label>
      Авто (OID):
      <select id="oidSelect"></select>
      <div class="muted">Берётся из API: /api/oids/</div>
    </label>

    <label>
      С (дата/время):
      <input id="dtFrom" type="datetime-local" />
    </label>

    <label>
      По (дата/время):
      <input id="dtTo" type="datetime-local" />
    </label>

    <label>
      GPS скачок (км):
      <input id="maxJump" type="number" step="0.1" value="1.0" style="width:130px;">
    </label>

    <label>
      Макс. скорость (км/ч):
      <input id="maxSpeed" type="number" step="10" value="180" style="width:150px;">
    </label>

    <label>
      Мин. длина рейса (км):
      <input id="minTripKm" type="number" step="0.1" value="1.0" style="width:150px;">
    </label>

    <button id="btnLoad" type="button">Загрузить по фильтру</button>
    <button id="btnExportXlsx" type="button">Экспорт в Excel</button>
    <button id="btnPrint" type="button">Печать</button>

    <div class="stat" id="stat">Готово. Выбери авто и даты → «Загрузить».</div>
  </div>

  <div class="mapBox">
    <div class="mapHeader">
      <b>Маршрут на карте (рейсы слоями)</b>
      <span class="muted" id="mapInfo"></span>
    </div>
    <div id="map"></div>
  </div>

</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
/* =========================================================
   НАСТРОЙКИ API
   ========================================================= */
const API_BASE = ""; // у тебя API на /api/...

function api(path){
  path = String(path || "").trim();
  if(!path.startsWith("/")) path = "/" + path;

  // отделяем query-string (чтобы не лепить "/" после "?")
  const qPos = path.indexOf("?");
  let p = qPos >= 0 ? path.slice(0, qPos) : path;
  const q = qPos >= 0 ? path.slice(qPos) : "";

  if(!p.endsWith("/")) p += "/";
  return API_BASE + p + q;
}

async function fetchJSON(url){
  const r = await fetch(url, { credentials: "same-origin" });
  if(!r.ok) throw new Error(`HTTP ${r.status}: ${await r.text()}`);
  return await r.json();
}

/* =========================================================
   DOM
   ========================================================= */
const oidSelect = document.getElementById("oidSelect");
const dtFrom = document.getElementById("dtFrom");
const dtTo = document.getElementById("dtTo");
const maxJump = document.getElementById("maxJump");
const maxSpeed = document.getElementById("maxSpeed");
const minTripKmEl = document.getElementById("minTripKm");
const btnLoad = document.getElementById("btnLoad");
const btnExportXlsx = document.getElementById("btnExportXlsx");
const btnPrint = document.getElementById("btnPrint");
const stat = document.getElementById("stat");
const mapInfo = document.getElementById("mapInfo");

const totalKmPointsCell = document.getElementById("total_km_points_cell");
const totalKmSumCell = document.getElementById("total_km_sum_cell");
const totalTonsSumCell = document.getElementById("total_tons_sum_cell");

const ttdKmDeliveryCell = document.getElementById("ttd_km_delivery_cell");
const ttd38IdleCell = document.getElementById("ttd_38_idle_cell");

const vehicleTonnageCell = document.getElementById("vehicle_tonnage_cell");
const tripsCountCell = document.getElementById("trips_count_cell");
const totalTonsCell = document.getElementById("total_tons_cell");

const routeSelects = Array.from(document.querySelectorAll("select.route"));
const ROUTES = new Map();

/* =========================================================
   ДЕФОЛТНЫЕ ДАТЫ (00:00 -> 23:59)
   ========================================================= */
function toDatetimeLocalValue(d){
  const pad = (n) => String(n).padStart(2, "0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function setDefaultDayBounds(){
  const now = new Date();
  const from = new Date(now); from.setHours(0, 0, 0, 0);
  const to = new Date(now);   to.setHours(23, 59, 0, 0);

  if (dtFrom && !dtFrom.value) dtFrom.value = toDatetimeLocalValue(from);
  if (dtTo && !dtTo.value) dtTo.value = toDatetimeLocalValue(to);
}
setDefaultDayBounds();

dtFrom.addEventListener("change", () => {
  if(!dtFrom.value) return;
  const d = new Date(dtFrom.value);
  d.setHours(0,0,0,0);
  dtFrom.value = toDatetimeLocalValue(d);
});
dtTo.addEventListener("change", () => {
  if(!dtTo.value) return;
  const d = new Date(dtTo.value);
  d.setHours(23,59,0,0);
  dtTo.value = toDatetimeLocalValue(d);
});

/* =========================================================
   СПРАВОЧНИК АВТО
   ========================================================= */
const VEHICLES = new Map([
  [716, { name: "КАМАЗ 532150 Е015НВ48 (дут)", tonnage: 9 }],
  [719, { name: "КАМАЗ 532150 М435КХ48 (дут)", tonnage: 9 }],
  [182, { name: "Камаз О537КР48 (дут)", tonnage: 14 }],
  [432, { name: "Камаз М968ОН48 (дут)", tonnage: 14 }],
  [717, { name: "КАМАЗ ЭД-405А Е102КХ48 (дут)", tonnage: 9 }],
]);

function getVehicleTonnage(){
  const oid = Number(oidSelect.value);
  const v = VEHICLES.get(oid);
  return v ? Number(v.tonnage) : 0;
}

/* =========================================================
   УТИЛИТЫ
   ========================================================= */
function dtLocalToApi(v){
  if(!v) return "";
  return v.replace("T"," ") + ":00";
}

function fmt2(x){
  if(x === null || x === undefined || x === "" || Number.isNaN(Number(x))) return "";
  return Number(x).toFixed(2).replace(".", ",");
}

function fmt1(x){
  if(x === null || x === undefined || x === "" || Number.isNaN(Number(x))) return "";
  return Number(x).toFixed(1).replace(".", ",");
}

function numOr0(v){
  const n = Number(v);
  return Number.isFinite(n) ? n : 0;
}

function parseTonsCellTextToNumber(txt){
  if(!txt) return 0;
  const s = String(txt).replace(/[^0-9,.\-]/g, "").replace(",", ".");
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function getRowWidth(row){
  const el = row.querySelector(".js-width");
  const w = el ? Number(String(el.textContent).replace(",", ".")) : NaN;
  return Number.isFinite(w) ? w : NaN;
}

function coeffByWidth(widthM){
  const w = Number(widthM);
  if (Math.abs(w - 7) < 0.01) return 1.4;
  if (Math.abs(w - 6) < 0.01) return 1.2;
  return 1.2;
}

/* =========================================================
   РАСЧЁТЫ В ТАБЛИЦЕ
   ========================================================= */
function recalcRowKm(row){
  const routeSel = row.querySelector("select.route");
  const kmCell = row.querySelector(".trip-km");
  const tonsInput = row.querySelector(".trip-tons");
  if(!kmCell || !tonsInput) return;

  if(!routeSel || !routeSel.value){
    kmCell.textContent = "";
    return;
  }

  const tons = numOr0(tonsInput.value);
  if(tons <= 0){
    kmCell.textContent = "";
    return;
  }

  const widthM = getRowWidth(row);
  const k = coeffByWidth(widthM);
  let km = tons / k;

  const lengthCell = row.querySelector(".js-length");
  const maxLen = Number(String(lengthCell.textContent).replace(",", "."));
  if (Number.isFinite(maxLen) && km > maxLen) km = maxLen;

  kmCell.textContent = fmt2(km);
}

function recalcRowDelivery(row){
  const deliveryCell = row.querySelector(".delivery-cell");
  const tonsInput = row.querySelector(".trip-tons");
  if(!deliveryCell || !tonsInput) return;

  const tons = numOr0(tonsInput.value);
  const vTonnage = getVehicleTonnage();

  if(tons <= 0 || vTonnage <= 0){
    deliveryCell.textContent = "";
    return;
  }

  const delivery = (tons / vTonnage) * 16.0;
  deliveryCell.textContent = fmt2(delivery);
}

function recalcDeliveryAndIdleTotals(){
  const vTonnage = getVehicleTonnage();
  const totalTonsAuto = parseTonsCellTextToNumber(totalTonsCell.textContent);
  const gpsKm = numOr0(String(totalKmPointsCell.textContent).replace(",", "."));
  const spreadKm = numOr0(String(totalKmSumCell.textContent).replace(",", "."));

  if(vTonnage <= 0){
    if(ttdKmDeliveryCell) ttdKmDeliveryCell.textContent = "";
    if(ttd38IdleCell) ttd38IdleCell.textContent = "";
    return;
  }

  const deliveryTotal = (totalTonsAuto / vTonnage) * 16.0;
  const idleTotal = gpsKm - spreadKm - deliveryTotal;

  if(ttdKmDeliveryCell) ttdKmDeliveryCell.textContent = fmt2(deliveryTotal);
  if(ttd38IdleCell) ttd38IdleCell.textContent = fmt2(idleTotal);
}

function recalcTotals(){
  let totalTons = 0;
  let totalKm = 0;

  const rows = Array.from(document.querySelectorAll("tr.data-row"));
  for(const row of rows){
    const sel = row.querySelector("select.route");
    const tonsInput = row.querySelector(".trip-tons");
    const kmCell = row.querySelector(".trip-km");

    if(!sel || !sel.value) continue;

    totalTons += numOr0(tonsInput ? tonsInput.value : 0);
    totalKm += numOr0(kmCell ? String(kmCell.textContent).replace(",", ".") : 0);
  }

  totalTonsSumCell.textContent = fmt2(totalTons);
  totalKmSumCell.textContent = fmt2(totalKm);
  recalcDeliveryAndIdleTotals();
}

function recalcRowAndTotals(row){
  recalcRowKm(row);
  recalcRowDelivery(row);
  recalcTotals();
}

function applyRouteToRow(selectEl){
  const row = selectEl.closest("tr");
  if(!row) return;

  const widthCell = row.querySelector(".js-width");
  const lengthCell = row.querySelector(".js-length");
  const tonsCell = row.querySelector(".js-tons");

  const name = selectEl.value;

  if(!name){
    if(widthCell) widthCell.textContent = "";
    if(lengthCell) lengthCell.textContent = "";
    if(tonsCell) tonsCell.textContent = "";
    const kmCell = row.querySelector(".trip-km");
    if(kmCell) kmCell.textContent = "";
    const delCell = row.querySelector(".delivery-cell");
    if(delCell) delCell.textContent = "";
    recalcTotals();
    return;
  }

  const r = ROUTES.get(name);
  if(!r){
    if(widthCell) widthCell.textContent = "";
    if(lengthCell) lengthCell.textContent = "";
    if(tonsCell) tonsCell.textContent = "";
    const kmCell = row.querySelector(".trip-km");
    if(kmCell) kmCell.textContent = "";
    const delCell = row.querySelector(".delivery-cell");
    if(delCell) delCell.textContent = "";
    recalcTotals();
    return;
  }

  if(widthCell)  widthCell.textContent  = (r.road_width_m ?? "") === "" ? "" : fmt1(r.road_width_m);
  if(lengthCell) lengthCell.textContent = (r.road_length_km ?? "") === "" ? "" : fmt2(r.road_length_km);
  if(tonsCell)   tonsCell.textContent   = (r.pss_tonnage_t ?? "") === "" ? "" : fmt2(r.pss_tonnage_t);

  recalcRowAndTotals(row);
}

function wireRouteSelects(){
  for(const sel of routeSelects){
    sel.addEventListener("change", () => applyRouteToRow(sel));
  }
}

function wireTonsInputs(){
  const rows = Array.from(document.querySelectorAll("tr.data-row"));
  for(const row of rows){
    const inp = row.querySelector(".trip-tons");
    if(!inp) continue;
    inp.addEventListener("input", () => recalcRowAndTotals(row));
  }
}

/* =========================================================
   ЗАГРУЗКА СПРАВОЧНИКОВ
   ========================================================= */
async function loadRoutes(){
  const data = await fetchJSON(api("api/routes"));
  ROUTES.clear();

  for(const r of (data.routes || [])){
    ROUTES.set(r.name, {
      road_width_m: r.road_width_m,
      road_length_km: r.road_length_km,
      pss_tonnage_t: r.pss_tonnage_t
    });
  }

  for(const sel of routeSelects){
    sel.innerHTML = "";

    const empty = document.createElement("option");
    empty.value = "";
    empty.textContent = "";
    sel.appendChild(empty);

    for(const name of ROUTES.keys()){
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      sel.appendChild(opt);
    }

    sel.value = "";
  }

  wireRouteSelects();
  wireTonsInputs();

  const rows = Array.from(document.querySelectorAll("tr.data-row"));
  rows.forEach(r => recalcRowDelivery(r));
  recalcTotals();
}

async function loadOids(){
  let apiOids = [];
  try{
    const data = await fetchJSON(api("api/oids"));
    apiOids = (data.oids || []).map(Number);
  }catch(e){
    apiOids = [];
  }

  const all = new Set([...apiOids, ...Array.from(VEHICLES.keys())]);
  const sorted = Array.from(all).sort((a,b)=>a-b);

  oidSelect.innerHTML = "";

  for(const oid of sorted){
    const meta = VEHICLES.get(oid);
    const label = meta ? `${meta.name} — ${oid} — ${meta.tonnage} т` : `OID ${oid}`;

    const opt = document.createElement("option");
    opt.value = String(oid);
    opt.textContent = label;

    if(!apiOids.includes(oid)) opt.textContent += " (нет точек)";
    oidSelect.appendChild(opt);
  }

  oidSelect.addEventListener("change", () => {
    const rows = Array.from(document.querySelectorAll("tr.data-row"));
    rows.forEach(r => recalcRowDelivery(r));
    recalcTotals();
  });
}

/* =========================================================
   КАРТА
   ========================================================= */
const map = L.map("map", { attributionControl: false }).setView([52.05, 37.99], 11);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: "" }).addTo(map);

const TRIP_COLORS = [
  "#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00",
  "#a65628","#f781bf","#999999","#1b9e77","#d95f02",
  "#7570b3","#66a61e","#e6ab02","#a6761d","#666666"
];

let layersControl = null;
let overlays = {};
let allBounds = null;

let sandBaseMarker = null;
let sandBaseCircle = null;

function clearTripsLayers(){
  for(const k of Object.keys(overlays)){
    map.removeLayer(overlays[k]);
  }
  overlays = {};

  if(layersControl){
    map.removeControl(layersControl);
    layersControl = null;
  }

  allBounds = null;

  if(sandBaseMarker){ map.removeLayer(sandBaseMarker); sandBaseMarker = null; }
  if(sandBaseCircle){ map.removeLayer(sandBaseCircle); sandBaseCircle = null; }
}

function addBounds(b){
  if(!b) return;
  if(!allBounds) allBounds = b;
  else allBounds.extend(b);
}

/* =========================================================
   ЗАГРУЗКА ПО ФИЛЬТРУ (GPS + рейсы)
   ========================================================= */
async function loadAll(){
  const oid = Number(oidSelect.value);
  const f = dtLocalToApi(dtFrom.value);
  const t = dtLocalToApi(dtTo.value);
  const mj = Number(maxJump.value || 1.0);
  const ms = Number(maxSpeed.value || 180);
  const minTripKm = Number(minTripKmEl.value || 1.0);

  const vmeta = VEHICLES.get(oid);
  const vehicleName = vmeta ? vmeta.name : `OID ${oid}`;
  const vehicleTonnage = vmeta ? Number(vmeta.tonnage) : 0;

  if(!oid){
    stat.textContent = "Выбери авто.";
    return;
  }

  stat.textContent = "Считаю…";

  // points_summary
  const qsSum = new URLSearchParams({
    oid: String(oid),
    max_jump_km: String(mj),
    max_speed_kmh: String(ms),
  });
  if(f) qsSum.set("dt_from", f);
  if(t) qsSum.set("dt_to", t);

  const sum = await fetchJSON(api("api/points_summary") + "?" + qsSum.toString());
  totalKmPointsCell.textContent = fmt2(sum.total_km || 0);

  vehicleTonnageCell.textContent = vehicleTonnage ? (vehicleTonnage.toFixed(0) + " т") : "—";
  tripsCountCell.textContent = "—";
  totalTonsCell.textContent = "—";

  recalcDeliveryAndIdleTotals();

  stat.innerHTML =
    `Авто: <b>${vehicleName}</b> (OID: ${sum.oid})<br>` +
    `Период: <b>${sum.dt_from || "—"}</b> … <b>${sum.dt_to || "—"}</b><br>` +
    `Точек (после фильтра): <b>${sum.points_count_used}</b><br>` +
    `Удалено скачков: <b>${sum.gps_jumps_removed}</b><br>` +
    `Общий км по GPS: <b>${fmt2(sum.total_km || 0)}</b><br>` +
    `Заезды на пескобазу (погрузка): <b>${sum.sand_base_entries ?? 0}</b>`;

  // trips_for_map
  mapInfo.textContent = "делю на рейсы и рисую слоями…";
  clearTripsLayers();

  const qsTrips = new URLSearchParams({
    oid: String(oid),
    max_points_per_trip: "2000",
    max_jump_km: String(mj),
    max_speed_kmh: String(ms),
    min_trip_km: String(minTripKm),
  });
  if(f) qsTrips.set("dt_from", f);
  if(t) qsTrips.set("dt_to", t);

  const tripsData = await fetchJSON(api("api/trips_for_map") + "?" + qsTrips.toString());

  const tripsCount = Number(tripsData.trips_count || 0);
  const totalTonsAuto = vehicleTonnage * tripsCount;

  vehicleTonnageCell.textContent = vehicleTonnage ? (vehicleTonnage.toFixed(0) + " т") : "—";
  tripsCountCell.textContent = String(tripsCount);
  totalTonsCell.textContent = vehicleTonnage ? (totalTonsAuto.toFixed(0) + " т") : "—";

  recalcDeliveryAndIdleTotals();

  const sb = tripsData.sand_base;
  if(sb){
    const sbLatLng = [sb.lat, sb.lon];
    sandBaseMarker = L.marker(sbLatLng).addTo(map).bindPopup("Пескобаза (погрузка)");
    sandBaseCircle = L.circle(sbLatLng, {
      radius: (sb.radius_km || 0.07) * 1000.0,
      weight: 2,
      fillOpacity: 0.05
    }).addTo(map);
    addBounds(sandBaseCircle.getBounds());
  }

  const trips = tripsData.trips || [];
  if(trips.length === 0){
    mapInfo.textContent = "рейсов не найдено (возможно нет въездов на пескобазу или все отфильтрованы)";
    if(allBounds) map.fitBounds(allBounds, {padding:[20,20]});
    return;
  }

  trips.forEach((tr, idx) => {
    const pts = (tr.points || []).map(p => [p.lat, p.lon]);
    if(pts.length < 2) return;

    const color = TRIP_COLORS[idx % TRIP_COLORS.length];
    const km = (tr.distance_km !== undefined && tr.distance_km !== null)
      ? tr.distance_km.toFixed(2).replace(".", ",")
      : "?";

    const name = `Рейс ${tr.trip_no} — ${km} км (${tr.tm_start || "?"} → ${tr.tm_end || "?"})`;

    const g = L.layerGroup();
    const line = L.polyline(pts, { weight: 5, color }).addTo(g);

    L.circleMarker(pts[0], { radius: 5, weight: 2, color }).addTo(g)
      .bindPopup(`Рейс ${tr.trip_no}: старт<br>${tr.tm_start || ""}`);
    L.circleMarker(pts[pts.length-1], { radius: 5, weight: 2, color }).addTo(g)
      .bindPopup(`Рейс ${tr.trip_no}: финиш<br>${tr.tm_end || ""}`);

    overlays[name] = g;
    g.addTo(map);
    addBounds(line.getBounds());
  });

  layersControl = L.control.layers(null, overlays, { collapsed: false }).addTo(map);

  if(allBounds) map.fitBounds(allBounds, { padding:[20,20] });

  mapInfo.textContent =
    `рейсов: ${tripsData.trips_count}, заездов на пескобазу: ${tripsData.sand_base_entries}, ` +
    `точек (в базе: ${tripsData.original_count}, после фильтра: ${tripsData.filtered_count}, скачков удалено: ${tripsData.gps_jumps_removed}), ` +
    `мин. длина рейса: ${minTripKm} км`;

  const rows = Array.from(document.querySelectorAll("tr.data-row"));
  rows.forEach(r => recalcRowDelivery(r));
  recalcTotals();
}

/* =========================================================
   ЭКСПОРТ: SAVE -> EXPORT_XLSX
   ========================================================= */
function collectTableData(){
  const rows = Array.from(document.querySelectorAll("tr.data-row"));
  const outRows = rows.map((row) => {
    const route = row.querySelector("select.route")?.value || "";
    const tripNo = row.children[1]?.textContent?.trim() || "";
    const km = row.querySelector(".trip-km")?.textContent?.trim() || "";
    const tons = row.querySelector(".trip-tons")?.value || "";
    const width = row.querySelector(".js-width")?.textContent?.trim() || "";
    const length = row.querySelector(".js-length")?.textContent?.trim() || "";
    const pssTonnage = row.querySelector(".js-tons")?.textContent?.trim() || "";
    const delivery = row.querySelector(".delivery-cell")?.textContent?.trim() || "";
    return { route, tripNo, km, tons, width, length, pssTonnage, delivery };
  });

  return {
    meta: {
      oid: oidSelect.value || "",
      dt_from: dtFrom.value || "",
      dt_to: dtTo.value || "",
    },
    totals: {
      km_spread: totalKmSumCell.textContent?.trim() || "",
      tons_sum: totalTonsSumCell.textContent?.trim() || "",
      km_gps: totalKmPointsCell.textContent?.trim() || "",
      delivery: ttdKmDeliveryCell?.textContent?.trim() || "",
      idle: ttd38IdleCell?.textContent?.trim() || ""
    },
    rows: outRows
  };
}

async function saveForm(payload){
  const r = await fetch(api("api/forms/save"), {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "same-origin",
    body: JSON.stringify(payload)
  });
  if(!r.ok) throw new Error(`SAVE HTTP ${r.status}: ${await r.text()}`);
  const data = await r.json();
  if(!data.form_id) throw new Error("SAVE: form_id not returned");
  return data.form_id;
}

async function downloadXlsx(formId){
  const r = await fetch(api(`api/forms/${encodeURIComponent(formId)}/export_xlsx`), {
    credentials: "same-origin"
  });
  if(!r.ok) throw new Error(`EXPORT HTTP ${r.status}: ${await r.text()}`);

  const blob = await r.blob();
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
  a.href = url;
  a.download = `Камаз-маз-${formId}-${ts}.xlsx`; // имя файла для скачивания
  document.body.appendChild(a);
  a.click();
  a.remove();

  URL.revokeObjectURL(url);
}

async function exportXlsx(){
  const payload = collectTableData();
  stat.textContent = "Сохраняю…";
  const formId = await saveForm(payload);
  stat.textContent = `Сохранено (id: ${formId}). Формирую Excel…`;
  await downloadXlsx(formId);
  stat.textContent = `Готово. Excel скачан. form_id: ${formId}`;
}

/* =========================================================
   КНОПКИ / СТАРТ
   ========================================================= */
btnExportXlsx.addEventListener("click", () => {
  exportXlsx().catch(e => stat.textContent = "Ошибка экспорта: " + e.message);
});

btnPrint.addEventListener("click", () => window.print());

btnLoad.addEventListener("click", () => {
  loadAll().catch(e => {
    stat.textContent = "Ошибка: " + e.message;
    mapInfo.textContent = "";
  });
});

// стартуем загрузку справочников
Promise.all([loadRoutes(), loadOids()])
  .then(() => { stat.textContent = "Справочник маршрутов и авто загружены."; })
  .catch(e => { stat.textContent = "Ошибка: " + e.message; });

</script>
</body>
</html>
