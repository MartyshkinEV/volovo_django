<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Путевой лист — Volovo</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root{
      --b:#000; --thin:1px; --thick:2.5px;
      --yellow:#ffd200; --green:#00e11a; --red:#ff2b2b;
    }
    body{ margin:20px; font-family: Arial, system-ui, sans-serif; }
    .wrap{ max-width: 1200px; }

    table.sheet{ border-collapse: collapse; width:100%; table-layout:fixed; border:var(--thick) solid var(--b); font-size:12px; }
    .sheet th,.sheet td{ border:var(--thin) solid var(--b); padding:6px; vertical-align:middle; background:#fff; word-wrap:break-word; }
    .thick-l{ border-left:var(--thick) solid var(--b) !important; }
    .thick-r{ border-right:var(--thick) solid var(--b) !important; }
    .thick-b{ border-bottom:var(--thick) solid var(--b) !important; }

    .title{ font-size:16px; letter-spacing:6px; text-align:center; padding:10px 0; font-weight:700; }
    .center{text-align:center;} .right{text-align:right;}

    .bg-red{background:var(--red)!important; font-weight:700;}

    select.route{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font:inherit;
    }

    input.tons-input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font:inherit;
      text-align:right;
    }

    col.c26{ width: 280px; } col.c27{ width: 60px; } col.c28{ width: 70px; } col.c29{ width: 70px; } col.c30{ width: 70px; }
    col.c31{ width: 70px; } col.c32{ width: 80px; } col.c33{ width: 80px; } col.c34{ width: 90px; } col.c35{ width: 90px; }
    col.c36{ width: 80px; } col.c37{ width: 70px; } col.c38{ width: 70px; } col.c39{ width: 110px; } col.c40{ width: 120px; }

    .filters{
      margin-top:14px; display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap;
      border:1px solid #ddd; border-radius:12px; padding:12px;
    }
    .filters label{ display:flex; flex-direction:column; gap:6px; font-size:12px; }
    .filters input,.filters select,.filters button{
      padding:8px 10px; border:1px solid #bbb; border-radius:10px; font-size:14px;
    }
    .filters button{ cursor:pointer; }
    .stat{
      margin-left:auto; font-size:14px; padding:8px 10px; border:1px solid #bbb; border-radius:10px;
      background:#fafafa; min-width: 460px;
    }
    .muted{ color:#555; font-size:12px; }

    .mapBox{ margin-top:14px; border:1px solid #ddd; border-radius:12px; overflow:hidden; }
    .mapHeader{ padding:10px 12px; background:#fafafa; border-bottom:1px solid #ddd; display:flex; gap:10px; align-items:baseline; flex-wrap:wrap; }
    #map{ height:520px; }

    body {
      background: #f5f7fa;
      font-family: "Inter", "Segoe UI", Arial, sans-serif;
      color: #222;
      margin: 20px;
    }

    .wrap { padding-bottom: 40px; }

    table.sheet {
      border: none !important;
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 4px 22px rgba(0,0,0,0.08);
      font-size: 13px;
    }

    .sheet th {
      background: #f0f2f5 !important;
      font-weight: 600;
      color: #333;
      border: none !important;
    }

    .sheet td {
      border: none !important;
      padding: 8px 10px;
    }

    .sheet tr:nth-child(even) td { background: #fafafa; }

    .sheet input, .sheet select {
      padding: 6px 8px;
      background: #fff;
      border-radius: 6px;
      border: 1px solid #d0d4da;
      transition: 0.15s;
    }

    .sheet input:focus, .sheet select:focus {
      border-color: #4a8dff;
      box-shadow: 0 0 0 3px rgba(74,141,255,0.25);
    }

    .bg-red { background: #ffb3b3 !important; font-weight: 700; }

    .title {
      font-size: 18px;
      padding: 14px 0;
      text-align: center;
      background: linear-gradient(90deg, #f0f0f5, #fafafa);
      border-bottom: 2px solid #e0e0e0;
      letter-spacing: 4px;
      font-weight: 700;
    }

    .filters {
      background: #ffffff;
      border: none;
      padding: 18px;
      border-radius: 14px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      box-shadow: 0 3px 12px rgba(0,0,0,0.06);
    }

    .filters label { font-size: 13px; color: #555; }

    .filters select, .filters input {
      border-radius: 10px;
      border: 1px solid #ccd1d8;
      background: #fff;
      transition: 0.15s;
    }

    .filters select:focus, .filters input:focus {
      border-color: #4a8dff;
      box-shadow: 0 0 0 3px rgba(74,141,255,0.25);
    }

    .filters button {
      background: #4a8dff;
      border: none;
      padding: 10px 18px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }

    .filters button:hover { background: #3a79e0; transform: translateY(-1px); }
    .filters button:active { transform: scale(0.97); }

    .stat {
      background: #f9fafc;
      border: 1px solid #d0d6dd;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 14px;
      min-width: 460px;
      box-shadow: inset 0 0 4px rgba(0,0,0,0.05);
    }

    .mapBox {
      margin-top: 18px;
      background: #fff;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 4px 18px rgba(0,0,0,0.08);
    }

    .mapHeader {
      background: #f5f7fa;
      border-bottom: 1px solid #dce1e6;
      padding: 12px 16px;
      font-size: 15px;
      font-weight: 600;
    }

    @media print {
      body { background: white; }
      table.sheet { box-shadow: none; border: 2px solid black !important; }
    }
  </style>
</head>

<body>
<div class="wrap">

  <table class="sheet" id="sheet">
    <colgroup>
      <col class="c26"><col class="c27"><col class="c28"><col class="c29"><col class="c30">
      <col class="c31"><col class="c32"><col class="c33"><col class="c34"><col class="c35">
      <col class="c36"><col class="c37"><col class="c38"><col class="c39"><col class="c40">
    </colgroup>

    <tr>
      <th colspan="13" class="title thick-b">ПОСЛЕДОВАТЕЛЬНОСТЬ ВЫПОЛНЕНИЯ ЗАДАНИЯ</th>
      <th rowspan="3" class="center thick-l thick-b">подпись</th>
      <th rowspan="3" class="center thick-b">расшифровка</th>
    </tr>

    <tr>
      <th rowspan="2" class="center thick-r">пункт погрузки, разгрузки<br>и перецепки прицепов</th>
      <th rowspan="2" class="center thick-r">номер<br>ездки</th>

      <th colspan="3" class="center thick-r">прибытие</th>

      <th colspan="3" class="center thick-r">параметры дороги (из справочника)</th>

      <th class="center thick-r">номер прицепа</th>
      <th class="center thick-r">порожний<br>пробег<br>прицепа</th>
      <th colspan="3" class="center thick-r">номера приложенных ТТД</th>
    </tr>

    <tr>
      <th class="center"></th>
      <th class="center bg-yellow">км</th>
      <th class="center bg-green thick-r">тонн</th>

      <th class="center">ширина (м)</th>
      <th class="center">длина (км)</th>
      <th class="center thick-r">тоннаж (т)</th>

      <th class="center thick-r"></th>
      <th class="center thick-r"></th>

      <th class="center">Доставка</th>
      <th class="center">37</th>
      <th class="center thick-r">Холостой ход</th>
    </tr>

    <!-- 8 строк -->
    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">1</td>
      <td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r">
        <input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder="">
      </td>

      <td class="center js-width"></td>
      <td class="right js-length"></td>
      <td class="right thick-r js-tons"></td>

      <td class="center thick-r"></td>
      <td class="right thick-r"></td>

      <!-- 36: доставка по строке -->
      <td class="right delivery-cell"></td>
      <!-- 37 -->
      <td></td>
      <!-- 38 -->
      <td class="right thick-r"></td>

      <td class="thick-l"></td><td></td>
    </tr>

    <!-- 2..8 -->
    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">2</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">3</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">4</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">5</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">6</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">7</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <tr class="data-row">
      <td class="thick-r"><select class="route"></select></td>
      <td class="center thick-r">8</td><td></td>
      <td class="right bg-yellow trip-km"></td>
      <td class="right bg-green thick-r"><input class="tons-input trip-tons" type="number" step="0.01" min="0" placeholder=""></td>
      <td class="center js-width"></td><td class="right js-length"></td><td class="right thick-r js-tons"></td>
      <td class="center thick-r"></td><td class="right thick-r"></td>
      <td class="right delivery-cell"></td><td></td><td class="thick-r"></td>
      <td class="thick-l"></td><td></td>
    </tr>

    <!-- ИТОГО -->
    <tr>
      <td class="thick-r"></td>
      <td class="thick-r"></td>
      <td></td>
      <td class="right bg-yellow" id="total_km_sum_cell">0,00</td>
      <td class="right bg-green thick-r" id="total_tons_sum_cell">0,00</td>
      <td></td>
      <td class="center bg-red" id="total_km_points_cell">0,00</td>
      <td class="center thick-r" id="vehicle_tonnage_cell">—</td>
      <td class="center thick-r" id="trips_count_cell">—</td>
      <td class="center thick-r" id="total_tons_cell">—</td>

      <!-- 36: ИТОГО доставка -->
      <td class="right" id="ttd_km_delivery_cell"></td>
      <!-- 37 -->
      <td></td>
      <!-- 38: ИТОГО холостой -->
      <td class="right thick-r" id="ttd_38_idle_cell"></td>

      <td class="thick-l"></td><td></td>
    </tr>

  </table>

  <div class="filters">
    <label>
      Авто (OID):
      <select id="oidSelect"></select>
      <div class="muted">Берётся из Mongo: distinct oid</div>
    </label>

    <label>
      С (дата/время):
      <input id="dtFrom" type="datetime-local" />
    </label>

    <label>
      По (дата/время):
      <input id="dtTo" type="datetime-local" />
    </label>

    <label>
      GPS скачок (км):
      <input id="maxJump" type="number" step="0.1" value="1.0" style="width:130px;">
    </label>

    <label>
      Макс. скорость (км/ч):
      <input id="maxSpeed" type="number" step="10" value="180" style="width:150px;">
    </label>

    <label>
      Мин. длина рейса (км):
      <input id="minTripKm" type="number" step="0.1" value="1.0" style="width:150px;">
    </label>

    <button id="btnLoad">Загрузить по фильтру</button>
    <button id="btnExportXlsx">Экспорт в Excel</button>
    <button id="btnPrint">Печать</button>

    <div class="stat" id="stat">Готово. Выбери авто и даты → «Загрузить».</div>
  </div>

  <div class="mapBox">
    <div class="mapHeader">
      <b>Маршрут на карте (рейсы слоями)</b>
      <span class="muted" id="mapInfo"></span>
    </div>
    <div id="map"></div>
  </div>

</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  const API = "/dj";

  const oidSelect = document.getElementById("oidSelect");
  const dtFrom = document.getElementById("dtFrom");
  const dtTo = document.getElementById("dtTo");
  const maxJump = document.getElementById("maxJump");
  const maxSpeed = document.getElementById("maxSpeed");
  const minTripKmEl = document.getElementById("minTripKm");
  const btnLoad = document.getElementById("btnLoad");
  const btnExportXlsx = document.getElementById("btnExportXlsx");
  const btnPrint = document.getElementById("btnPrint");
  const stat = document.getElementById("stat");
  const mapInfo = document.getElementById("mapInfo");

  // итоги
  const totalKmPointsCell = document.getElementById("total_km_points_cell"); // GPS total (из API)
  const totalKmSumCell = document.getElementById("total_km_sum_cell");       // расчётный км по введённым тоннам
  const totalTonsSumCell = document.getElementById("total_tons_sum_cell");   // сумма введённых тонн

  // TTD-итоги (теперь в строке ИТОГО)
  const ttdKmDeliveryCell = document.getElementById("ttd_km_delivery_cell");
  const ttd38IdleCell = document.getElementById("ttd_38_idle_cell");

  // авто-итоги
  const vehicleTonnageCell = document.getElementById("vehicle_tonnage_cell");
  const tripsCountCell = document.getElementById("trips_count_cell");
  const totalTonsCell = document.getElementById("total_tons_cell");

  const routeSelects = Array.from(document.querySelectorAll("select.route"));

  const VEHICLES = new Map([
    [716, { name: "КАМАЗ 532150 Е015НВ48 (дут)", tonnage: 9 }],
    [719, { name: "КАМАЗ 532150 М435КХ48 (дут)", tonnage: 9 }],
    [182, { name: "Камаз О537КР48 (дут)", tonnage: 14 }],
    [432, { name: "Камаз М968ОН48 (дут)", tonnage: 14 }],
    [717, { name: "КАМАЗ ЭД-405А Е102КХ48 (дут)", tonnage: 9 }],
  ]);

  const ROUTES = new Map();

  function dtLocalToApi(v){
    if(!v) return "";
    return v.replace("T"," ") + ":00";
  }

  function fmt2(x){
    if(x === null || x === undefined || x === "" || Number.isNaN(Number(x))) return "";
    return Number(x).toFixed(2).replace(".", ",");
  }

  function fmt1(x){
    if(x === null || x === undefined || x === "" || Number.isNaN(Number(x))) return "";
    return Number(x).toFixed(1).replace(".", ",");
  }

  function numOr0(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function parseTonsCellTextToNumber(txt){
    // "518 т" -> 518
    if(!txt) return 0;
    const s = String(txt).replace(/[^0-9,.\-]/g, "").replace(",", ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function getVehicleTonnage(){
    const oid = Number(oidSelect.value);
    const v = VEHICLES.get(oid);
    return v ? Number(v.tonnage) : 0;
  }

  async function fetchJSON(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error(`HTTP ${r.status}: ${await r.text()}`);
    return await r.json();
  }

  // ---- MAP ----
  const map = L.map("map").setView([52.05, 37.99], 11);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  const TRIP_COLORS = [
    "#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00",
    "#a65628","#f781bf","#999999","#1b9e77","#d95f02",
    "#7570b3","#66a61e","#e6ab02","#a6761d","#666666"
  ];

  let layersControl = null;
  let overlays = {};
  let allBounds = null;

  let sandBaseMarker = null;
  let sandBaseCircle = null;

  function clearTripsLayers(){
    for(const k of Object.keys(overlays)){
      map.removeLayer(overlays[k]);
    }
    overlays = {};

    if(layersControl){
      map.removeControl(layersControl);
      layersControl = null;
    }
    allBounds = null;

    if(sandBaseMarker){ map.removeLayer(sandBaseMarker); sandBaseMarker = null; }
    if(sandBaseCircle){ map.removeLayer(sandBaseCircle); sandBaseCircle = null; }
  }

  function addBounds(b){
    if(!b) return;
    if(!allBounds){
      allBounds = b;
    }else{
      allBounds.extend(b);
    }
  }

  function coeffByWidth(widthM){
    const w = Number(widthM);
    if (Math.abs(w - 7) < 0.01) return 1.4;
    if (Math.abs(w - 6) < 0.01) return 1.2;
    return 1.2;
  }

  function getRowWidth(row){
    const el = row.querySelector(".js-width");
    const w = el ? Number(String(el.textContent).replace(",", ".")) : NaN;
    return Number.isFinite(w) ? w : NaN;
  }

  function recalcRowKm(row){
    const routeSel = row.querySelector("select.route");
    const kmCell = row.querySelector(".trip-km");
    const tonsInput = row.querySelector(".trip-tons");

    if(!kmCell || !tonsInput) return;

    if(!routeSel || !routeSel.value){
      kmCell.textContent = "";
      return;
    }

    const tons = numOr0(tonsInput.value);
    if(tons <= 0){
      kmCell.textContent = "";
      return;
    }

    const widthM = getRowWidth(row);
    const k = coeffByWidth(widthM);
    let km = tons / k;

    // Ограничение по длине маршрута
    const lengthCell = row.querySelector(".js-length");
    const maxLen = Number(String(lengthCell.textContent).replace(",", "."));
    if (Number.isFinite(maxLen) && km > maxLen) {
      km = maxLen;
    }

    kmCell.textContent = fmt2(km);
  }

  // ✅ доставка по строке: (тонн / тоннаж_авто) * 16
  function recalcRowDelivery(row){
    const deliveryCell = row.querySelector(".delivery-cell");
    const tonsInput = row.querySelector(".trip-tons");
    if(!deliveryCell || !tonsInput) return;

    const tons = numOr0(tonsInput.value);
    const vTonnage = getVehicleTonnage();

    if(tons <= 0 || vTonnage <= 0){
      deliveryCell.textContent = "";
      return;
    }

    const delivery = (tons / vTonnage) * 16.0;
    deliveryCell.textContent = fmt2(delivery);
  }

  function recalcTotals(){
    let totalTons = 0;
    let totalKm = 0;

    const rows = Array.from(document.querySelectorAll("tr.data-row"));
    for(const row of rows){
      const sel = row.querySelector("select.route");
      const tonsInput = row.querySelector(".trip-tons");
      const kmCell = row.querySelector(".trip-km");

      if(!sel || !sel.value) continue;

      const tons = numOr0(tonsInput ? tonsInput.value : 0);
      totalTons += tons;

      const km = numOr0(kmCell ? String(kmCell.textContent).replace(",", ".") : 0);
      totalKm += km;
    }

    totalTonsSumCell.textContent = fmt2(totalTons);
    totalKmSumCell.textContent = fmt2(totalKm);

    recalcDeliveryAndIdleTotals(); // ✅ итоги доставки/холостого
  }

  // ✅ ИТОГО доставка: (общий тоннаж авто / тоннаж авто) * 16
  // где "общий тоннаж авто" = totalTonsCell (например "518 т")
  function recalcDeliveryAndIdleTotals(){
    const vTonnage = getVehicleTonnage();
    const totalTonsAuto = parseTonsCellTextToNumber(totalTonsCell.textContent);
    const gpsKm = numOr0(String(totalKmPointsCell.textContent).replace(",", "."));
    const spreadKm = numOr0(String(totalKmSumCell.textContent).replace(",", "."));

    if(vTonnage <= 0){
      if(ttdKmDeliveryCell) ttdKmDeliveryCell.textContent = "";
      if(ttd38IdleCell) ttd38IdleCell.textContent = "";
      return;
    }

    const deliveryTotal = (totalTonsAuto / vTonnage) * 16.0;
    const idleTotal = gpsKm - spreadKm - deliveryTotal;

    if(ttdKmDeliveryCell) ttdKmDeliveryCell.textContent = fmt2(deliveryTotal);
    if(ttd38IdleCell) ttd38IdleCell.textContent = fmt2(idleTotal);
  }

  function recalcRowAndTotals(row){
    recalcRowKm(row);
    recalcRowDelivery(row);
    recalcTotals();
  }

  function applyRouteToRow(selectEl){
    const row = selectEl.closest("tr");
    if(!row) return;

    const widthCell = row.querySelector(".js-width");
    const lengthCell = row.querySelector(".js-length");
    const tonsCell = row.querySelector(".js-tons");

    const name = selectEl.value;

    if(!name){
      if(widthCell) widthCell.textContent = "";
      if(lengthCell) lengthCell.textContent = "";
      if(tonsCell) tonsCell.textContent = "";
      const kmCell = row.querySelector(".trip-km");
      if(kmCell) kmCell.textContent = "";
      const delCell = row.querySelector(".delivery-cell");
      if(delCell) delCell.textContent = "";
      recalcTotals();
      return;
    }

    const r = ROUTES.get(name);
    if(!r){
      if(widthCell) widthCell.textContent = "";
      if(lengthCell) lengthCell.textContent = "";
      if(tonsCell) tonsCell.textContent = "";
      const kmCell = row.querySelector(".trip-km");
      if(kmCell) kmCell.textContent = "";
      const delCell = row.querySelector(".delivery-cell");
      if(delCell) delCell.textContent = "";
      recalcTotals();
      return;
    }

    if(widthCell) widthCell.textContent = (r.road_width_m ?? "") === "" ? "" : fmt1(r.road_width_m);
    if(lengthCell) lengthCell.textContent = (r.road_length_km ?? "") === "" ? "" : fmt2(r.road_length_km);
    if(tonsCell) tonsCell.textContent = (r.pss_tonnage_t ?? "") === "" ? "" : fmt2(r.pss_tonnage_t);

    recalcRowAndTotals(row);
  }

  function wireRouteSelects(){
    for(const sel of routeSelects){
      sel.addEventListener("change", () => applyRouteToRow(sel));
    }
  }

  function wireTonsInputs(){
    const rows = Array.from(document.querySelectorAll("tr.data-row"));
    for(const row of rows){
      const inp = row.querySelector(".trip-tons");
      if(!inp) continue;
      inp.addEventListener("input", () => recalcRowAndTotals(row));
    }
  }

  async function loadRoutes(){
    const data = await fetchJSON(`${API}/api/routes`);
    ROUTES.clear();

    for(const r of (data.routes || [])){
      ROUTES.set(r.name, {
        road_width_m: r.road_width_m,
        road_length_km: r.road_length_km,
        pss_tonnage_t: r.pss_tonnage_t
      });
    }

    for(const sel of routeSelects){
      sel.innerHTML = "";

      const empty = document.createElement("option");
      empty.value = "";
      empty.textContent = "";
      sel.appendChild(empty);

      for(const name of ROUTES.keys()){
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      }

      sel.value = "";
    }

    wireRouteSelects();
    wireTonsInputs();

    // пересчёт сразу
    const rows = Array.from(document.querySelectorAll("tr.data-row"));
    rows.forEach(r => recalcRowDelivery(r));
    recalcTotals();
  }

  async function loadOids(){
    let apiOids = [];
    try{
      const data = await fetchJSON(`${API}/api/oids`);
      apiOids = (data.oids || []).map(Number);
    }catch(e){
      apiOids = [];
    }

    const all = new Set([...apiOids, ...Array.from(VEHICLES.keys())]);
    const sorted = Array.from(all).sort((a,b)=>a-b);

    oidSelect.innerHTML = "";

    for(const oid of sorted){
      const meta = VEHICLES.get(oid);
      const label = meta ? `${meta.name} — ${oid} — ${meta.tonnage} т` : `OID ${oid}`;

      const opt = document.createElement("option");
      opt.value = String(oid);
      opt.textContent = label;

      if(!apiOids.includes(oid)){
        opt.textContent += " (нет точек)";
      }

      oidSelect.appendChild(opt);
    }

    // ✅ при смене авто — пересчёт доставки по строкам и итогов
    oidSelect.addEventListener("change", () => {
      const rows = Array.from(document.querySelectorAll("tr.data-row"));
      rows.forEach(r => recalcRowDelivery(r));
      recalcTotals();
    });
  }

  async function loadAll(){
    const oid = Number(oidSelect.value);
    const f = dtLocalToApi(dtFrom.value);
    const t = dtLocalToApi(dtTo.value);
    const mj = Number(maxJump.value || 1.0);
    const ms = Number(maxSpeed.value || 180);
    const minTripKm = Number(minTripKmEl.value || 1.0);

    const vmeta = VEHICLES.get(oid);
    const vehicleName = vmeta ? vmeta.name : `OID ${oid}`;
    const vehicleTonnage = vmeta ? Number(vmeta.tonnage) : 0;

    if(!oid){
      stat.textContent = "Выбери авто.";
      return;
    }

    stat.textContent = "Считаю…";

    const urlSum = `${API}/api/points_summary?oid=${encodeURIComponent(oid)}`
      + (f ? `&dt_from=${encodeURIComponent(f)}` : "")
      + (t ? `&dt_to=${encodeURIComponent(t)}` : "")
      + `&max_jump_km=${encodeURIComponent(mj)}`
      + `&max_speed_kmh=${encodeURIComponent(ms)}`;

    const sum = await fetchJSON(urlSum);
    totalKmPointsCell.textContent = fmt2(sum.total_km || 0);

    vehicleTonnageCell.textContent = vehicleTonnage ? (vehicleTonnage.toFixed(0) + " т") : "—";
    tripsCountCell.textContent = "—";
    totalTonsCell.textContent = "—";

    recalcDeliveryAndIdleTotals();

    stat.innerHTML =
      `Авто: <b>${vehicleName}</b> (OID: ${sum.oid})<br>` +
      `Период: <b>${sum.dt_from || "—"}</b> … <b>${sum.dt_to || "—"}</b><br>` +
      `Точек (после фильтра): <b>${sum.points_count_used}</b><br>` +
      `Удалено скачков: <b>${sum.gps_jumps_removed}</b><br>` +
      `Общий км по GPS: <b>${fmt2(sum.total_km || 0)}</b><br>` +
      `Заезды на пескобазу (погрузка): <b>${sum.sand_base_entries ?? 0}</b>`;

    mapInfo.textContent = "делю на рейсы и рисую слоями…";
    clearTripsLayers();

    const urlTrips = `${API}/api/trips_for_map?oid=${encodeURIComponent(oid)}`
      + (f ? `&dt_from=${encodeURIComponent(f)}` : "")
      + (t ? `&dt_to=${encodeURIComponent(t)}` : "")
      + `&max_points_per_trip=2000`
      + `&max_jump_km=${encodeURIComponent(mj)}`
      + `&max_speed_kmh=${encodeURIComponent(ms)}`
      + `&min_trip_km=${encodeURIComponent(minTripKm)}`;

    const tripsData = await fetchJSON(urlTrips);

    const tripsCount = Number(tripsData.trips_count || 0);
    const totalTonsAuto = vehicleTonnage * tripsCount;

    vehicleTonnageCell.textContent = vehicleTonnage ? (vehicleTonnage.toFixed(0) + " т") : "—";
    tripsCountCell.textContent = String(tripsCount);
    totalTonsCell.textContent = vehicleTonnage ? (totalTonsAuto.toFixed(0) + " т") : "—";

    // ✅ пересчёт итогов (по твоей формуле)
    recalcDeliveryAndIdleTotals();

    const sb = tripsData.sand_base;
    if(sb){
      const sbLatLng = [sb.lat, sb.lon];
      sandBaseMarker = L.marker(sbLatLng).addTo(map).bindPopup("Пескобаза (погрузка)");
      sandBaseCircle = L.circle(sbLatLng, {
        radius: (sb.radius_km || 0.07) * 1000.0,
        weight: 2,
        fillOpacity: 0.05
      }).addTo(map);
      addBounds(sandBaseCircle.getBounds());
    }

    const trips = tripsData.trips || [];
    if(trips.length === 0){
      mapInfo.textContent = "рейсов не найдено (возможно нет въездов на пескобазу или все отфильтрованы)";
      if(allBounds) map.fitBounds(allBounds, {padding:[20,20]});
      return;
    }

    trips.forEach((tr, idx) => {
      const pts = (tr.points || []).map(p => [p.lat, p.lon]);
      if(pts.length < 2) return;

      const color = TRIP_COLORS[idx % TRIP_COLORS.length];
      const km = (tr.distance_km !== undefined && tr.distance_km !== null)
        ? tr.distance_km.toFixed(2).replace(".", ",")
        : "?";

      const name = `Рейс ${tr.trip_no} — ${km} км (${tr.tm_start || "?"} → ${tr.tm_end || "?"})`;

      const g = L.layerGroup();
      const line = L.polyline(pts, { weight: 5, color }).addTo(g);

      L.circleMarker(pts[0], { radius: 5, weight: 2, color }).addTo(g)
        .bindPopup(`Рейс ${tr.trip_no}: старт<br>${tr.tm_start || ""}`);
      L.circleMarker(pts[pts.length-1], { radius: 5, weight: 2, color }).addTo(g)
        .bindPopup(`Рейс ${tr.trip_no}: финиш<br>${tr.tm_end || ""}`);

      overlays[name] = g;
      g.addTo(map);

      addBounds(line.getBounds());
    });

    layersControl = L.control.layers(null, overlays, { collapsed: false }).addTo(map);

    if(allBounds){
      map.fitBounds(allBounds, { padding:[20,20] });
    }

    mapInfo.textContent =
      `рейсов: ${tripsData.trips_count}, заездов на пескобазу: ${tripsData.sand_base_entries}, ` +
      `точек (в базе: ${tripsData.original_count}, после фильтра: ${tripsData.filtered_count}, скачков удалено: ${tripsData.gps_jumps_removed}), ` +
      `мин. длина рейса: ${minTripKm} км`;

    // ✅ пересчёт строк доставки/итогов
    const rows = Array.from(document.querySelectorAll("tr.data-row"));
    rows.forEach(r => recalcRowDelivery(r));
    recalcTotals();
  }

  // ---- EXPORT: SAVE TO MONGO -> EXPORT BY ID ----
  function collectTableData(){
    const rows = Array.from(document.querySelectorAll("tr.data-row"));
    const outRows = rows.map((row) => {
      const route = row.querySelector("select.route")?.value || "";
      const tripNo = row.children[1]?.textContent?.trim() || "";
      const km = row.querySelector(".trip-km")?.textContent?.trim() || "";
      const tons = row.querySelector(".trip-tons")?.value || "";
      const width = row.querySelector(".js-width")?.textContent?.trim() || "";
      const length = row.querySelector(".js-length")?.textContent?.trim() || "";
      const pssTonnage = row.querySelector(".js-tons")?.textContent?.trim() || "";

      // ✅ доставка ПО СТРОКЕ
      const delivery = row.querySelector(".delivery-cell")?.textContent?.trim() || "";

      return { route, tripNo, km, tons, width, length, pssTonnage, delivery };
    });

    return {
      meta: {
        oid: oidSelect.value || "",
        dt_from: dtFrom.value || "",
        dt_to: dtTo.value || "",
      },
      totals: {
        km_spread: totalKmSumCell.textContent?.trim() || "",
        tons_sum: totalTonsSumCell.textContent?.trim() || "",
        km_gps: totalKmPointsCell.textContent?.trim() || "",
        // ✅ итоги (теперь в строке ИТОГО)
        delivery: ttdKmDeliveryCell?.textContent?.trim() || "",
        idle: ttd38IdleCell?.textContent?.trim() || ""
      },
      rows: outRows
    };
  }

  async function saveFormToMongo(payload){
    const r = await fetch(`${API}/api/forms/save`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
    if(!r.ok){
      throw new Error(`SAVE HTTP ${r.status}: ${await r.text()}`);
    }
    const data = await r.json();
    if(!data.form_id) throw new Error("SAVE: form_id not returned");
    return data.form_id;
  }

  async function downloadXlsxByFormId(formId){
    const r = await fetch(`${API}/api/forms/${encodeURIComponent(formId)}/export_xlsx`);
    if(!r.ok){
      throw new Error(`EXPORT HTTP ${r.status}: ${await r.text()}`);
    }
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
    a.href = url;
    a.download = `putevoy-${formId}-${ts}.xlsx`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }

  async function exportXlsx(){
    const payload = collectTableData();
    stat.textContent = "Сохраняю в MongoDB…";
    const formId = await saveFormToMongo(payload);
    stat.textContent = `Сохранено (id: ${formId}). Формирую Excel…`;
    await downloadXlsxByFormId(formId);
    stat.textContent = `Готово. Excel скачан. form_id: ${formId}`;
  }

  btnExportXlsx.addEventListener("click", () => {
    exportXlsx().catch(e => {
      stat.textContent = "Ошибка экспорта: " + e.message;
    });
  });

  // ---- PRINT ----
  btnPrint.addEventListener("click", () => window.print());

  btnLoad.addEventListener("click", () => {
    loadAll().catch(e => {
      stat.textContent = "Ошибка: " + e.message;
      mapInfo.textContent = "";
    });
  });

  Promise.all([loadRoutes(), loadOids()])
    .then(() => stat.textContent = "Справочник маршрутов и авто загружены.")
    .catch(e => stat.textContent = "Ошибка: " + e.message);
</script>
</body>
</html>
